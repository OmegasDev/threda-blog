---
import { format } from 'date-fns';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import AdPlacement from '../../components/AdPlacement.astro';
import { supabase } from '../../lib/supabase';

export async function getStaticPaths() {
  const { data: posts } = await supabase
    .from('posts')
    .select('slug')
    .eq('published', true);

  return posts?.map((post) => ({
    params: { slug: post.slug },
  })) || [];
}

const { slug } = Astro.params;

// Fetch the post
const { data: post } = await supabase
  .from('posts')
  .select(`
    *,
    category:categories(*)
  `)
  .eq('slug', slug)
  .eq('published', true)
  .single();

if (!post) {
  return Astro.redirect('/404');
}

// Increment view count
await supabase
  .from('posts')
  .update({ view_count: post.view_count + 1 })
  .eq('id', post.id);

// Fetch related posts
const { data: relatedPosts } = await supabase
  .from('posts')
  .select(`
    *,
    category:categories(*)
  `)
  .eq('category_id', post.category_id)
  .eq('published', true)
  .neq('id', post.id)
  .limit(3);

const formattedDate = format(new Date(post.created_at), 'MMMM dd, yyyy');
const readingTime = Math.ceil(post.content.split(' ').length / 200);
---

<Layout 
  title={post.seo_title || post.title}
  description={post.seo_description || post.excerpt}
  ogImage={post.featured_image}
>
  <Header />
  
  <main>
    <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
      <!-- Article Header -->
      <header class="mb-8">
        {post.category && (
          <div class="mb-4">
            <a 
              href={`/category/${post.category.slug}`}
              class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium text-white"
              style={`background-color: ${post.category.color}`}
            >
              {post.category.name}
            </a>
          </div>
        )}
        
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
          {post.title}
        </h1>
        
        <div class="flex flex-wrap items-center text-gray-600 text-sm gap-4 mb-6">
          <time datetime={post.created_at}>{formattedDate}</time>
          <span>â€¢</span>
          <span>{readingTime} min read</span>
          <span>â€¢</span>
          <span>{post.view_count + 1} views</span>
          {post.trending_score > 50 && (
            <>
              <span>â€¢</span>
              <span class="text-red-500 font-medium">ðŸ”¥ Trending</span>
            </>
          )}
        </div>

        {post.featured_image && (
          <div class="mb-8">
            <img 
              src={post.featured_image} 
              alt={post.title}
              class="w-full h-96 object-cover rounded-xl shadow-lg"
            />
          </div>
        )}
        
        <div class="text-xl text-gray-700 leading-relaxed mb-8 font-medium">
          {post.excerpt}
        </div>
      </header>

      <!-- Ad Placement -->
      <AdPlacement position="article-top" className="mb-8" />

      <!-- Article Content -->
      <div class="prose prose-lg max-w-none">
        <div set:html={post.content}></div>
      </div>

      <!-- Ad Placement -->
      <AdPlacement position="article-bottom" className="my-12" />

      <!-- Article Footer -->
      <footer class="border-t border-gray-200 pt-8 mt-12">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <span class="text-gray-600">Share this article:</span>
            <a 
              href={`https://twitter.com/intent/tweet?text=${encodeURIComponent(post.title)}&url=${encodeURIComponent(Astro.url.toString())}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-blue-500 hover:text-blue-600 transition-colors"
            >
              Twitter
            </a>
            <a 
              href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.toString())}`}
              target="_blank"
              rel="noopener noreferrer"
              class="text-blue-600 hover:text-blue-700 transition-colors"
            >
              Facebook
            </a>
          </div>
        </div>
      </footer>
    </article>

    <!-- Related Posts -->
    {relatedPosts && relatedPosts.length > 0 && (
      <section class="bg-gray-50 py-16">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <h2 class="text-3xl font-bold text-gray-900 mb-8">Related Articles</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {relatedPosts.map((relatedPost) => (
              <article class="bg-white rounded-xl shadow-sm hover:shadow-md transition-shadow">
                {relatedPost.featured_image && (
                  <img 
                    src={relatedPost.featured_image} 
                    alt={relatedPost.title}
                    class="w-full h-48 object-cover rounded-t-xl"
                  />
                )}
                <div class="p-6">
                  <h3 class="font-bold text-lg text-gray-900 mb-3 line-clamp-2">
                    <a href={`/post/${relatedPost.slug}`} class="hover:text-blue-600 transition-colors">
                      {relatedPost.title}
                    </a>
                  </h3>
                  <p class="text-gray-600 text-sm line-clamp-3 mb-4">
                    {relatedPost.excerpt}
                  </p>
                  <a 
                    href={`/post/${relatedPost.slug}`}
                    class="text-blue-600 hover:text-blue-700 font-medium text-sm transition-colors"
                  >
                    Read more â†’
                  </a>
                </div>
              </article>
            ))}
          </div>
        </div>
      </section>
    )}
  </main>

  <Footer />
</Layout>

<style>
  .prose {
    color: #374151;
  }
  
  .prose h2, .prose h3, .prose h4 {
    color: #111827;
    font-weight: 700;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }
  
  .prose p {
    margin-bottom: 1.5rem;
    line-height: 1.8;
  }
  
  .prose img {
    border-radius: 0.5rem;
    margin: 2rem 0;
  }
  
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>